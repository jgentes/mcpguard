name: CI

on:
  push:
    branches: [ main ]
    paths-ignore:
      - 'docs-site/**'
  pull_request:
    branches: [ main ]
    paths-ignore:
      - 'docs-site/**'

permissions:
  contents: read

jobs:
  test:
    name: Test
    runs-on: ubuntu-latest
    
    strategy:
      matrix:
        node-version: [20.x, 22.x]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Verify release-it configuration
        run: |
          SKIP_CHECKS_VALUE=$(node -p "require('./.release-it.json').npm.skipChecks")
          if [ "$SKIP_CHECKS_VALUE" != "true" ]; then
            echo "::error::npm.skipChecks must be true for Trusted Publishing (OIDC)"
            echo "This is REQUIRED per release-it documentation."
            exit 1
          fi
          echo "✅ release-it skipChecks configuration verified"
      
      - name: Verify version sync
        run: |
          MAIN_VERSION=$(node -p "require('./package.json').version")
          VSCODE_VERSION=$(node -p "require('./vscode-extension/package.json').version")
          if [ "$MAIN_VERSION" != "$VSCODE_VERSION" ]; then
            echo "::error::Version mismatch: Main package ($MAIN_VERSION) != VSCode extension ($VSCODE_VERSION)"
            echo "Please ensure versions are in sync before pushing."
            exit 1
          fi
          echo "✅ Versions in sync: $MAIN_VERSION"
      
      - name: Lint
        run: npm run lint
      
      - name: Type check
        run: npm run build
      
      - name: Run tests
        run: npm run test
        env:
          NODE_ENV: test
      
      - name: Upload coverage reports
        if: matrix.node-version == '20.x'
        uses: codecov/codecov-action@v4
        with:
          files: ./coverage/coverage-final.json
          flags: unittests
          name: codecov-umbrella
          fail_ci_if_error: false
        env:
          CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  lint:
    name: Lint & Format Check
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Check formatting
        run: npm run check

